
add_namespace = occupied_countries

#instantiate a collabration government
country_event = {
	id = occupied_countries.1
	title = occupied_countries.1.title
	desc = occupied_countries.1.desc
	
	# todo lar
	picture = GFX_report_event_canadian_soldiers
	
	is_triggered_only = yes

	#option = {
	#	name = occupied_countries.1.a
	#	unlock_decision_tooltip = instantiate_collaboration
	##	if = {
	##		limit = {
	##			has_core_occupation_modifier = {
	##				occupied_country_tag = FROM.FROM
	##				modifier = compliance_80
	##			}
	##			NOT = {
	##				any_country_with_original_tag = { #copy of is_available_to_collaboration_government but from from scope because of events
	##					original_tag_to_check = FROM.FROM
	##					is_puppet_of = PREV # if already created one do not create another
	##					has_autonomy_state = autonomy_collaboration_government
	##				}
	##			}
	##		}
	##		set_temp_variable = { country_to_initiate = FROM.FROM }
	##		instantiate_collaboration_government = yes
	##	}
	#	
	#	ai_chance = {
	#		base = 0
	#	}
	#}

	option = {
		name = occupied_countries.1.b
		# do nothing
		unlock_decision_tooltip = instantiate_collaboration
		ai_chance = {
			base = 100
		}
	}
}


# create uprising
country_event = {
	id = occupied_countries.2
	
	is_triggered_only = yes
	
	hidden = yes
	
	immediate = {		
		FROM = {
			if = {
				limit = {
					has_core_occupation_modifier = {
						occupied_country_tag = FROM
						modifier = resistance_90
					}
				}
				
				set_temp_variable = { occupier_country = THIS }
				set_temp_variable = { occupied_country = FROM }
				set_temp_variable = { new_occupied_country = FROM }
				FROM = { save_event_target_as = new_controller }	
				
				if = { #warsaw achievement
					limit = {
						var:occupied_country = { original_tag = POL }
					}
					set_global_flag = warsaw_liberated_self_flag
				}
				#if = { #raj tag
				#	limit = {
				#		var:occupied_country = { 
				#			original_tag = RAJ
				#			owns_state = 320
				#			NOT = {
				#				OR = {
				#					owns_state = 439
				#					owns_state = 321
				#				}
				#			}
				#		}
				#	}
				#	create_country_leader = { #elected senator of Pondichéry and communism
				#		name = "Caïlacha Subbiah"
				#		desc = "POLITICS_LORD_LINLITHGOW_DESC"
				#		picture = "gfx/leaders/RAJ/Portrait_The_Raj_Political_Leader_Generic_2.dds"
				#		expire = "1965.1.1"
				#		ideology = marxism
				#		traits = {
				#			
				#		}
				#	}
				#	create_country_leader = { #representative of Pondichéry
				#		name = "Deiva Zivarattinam"
				#		desc = "POLITICS_LORD_LINLITHGOW_DESC"
				#		picture = "gfx/leaders/RAJ/Portrait_The_Raj_Political_Leader_Generic_2.dds"
				#		expire = "1965.1.1"
				#		ideology = conservatism
				#		traits = {
				#			
				#		}
				#	}	
				#	create_country_leader = { #copy a second time because it's better than a random brit.
				#		name = "Deiva Zivarattinam"
				#		desc = "POLITICS_LORD_LINLITHGOW_DESC"
				#		picture = "gfx/leaders/RAJ/Portrait_The_Raj_Political_Leader_Generic_2.dds"
				#		expire = "1965.1.1"
				#		ideology = centrism
				#		traits = {
				#			
				#		}
				#	}
				#	create_country_leader = { #copy a second time because it's better than a random brit.
				#		name = "Deiva Zivarattinam"
				#		desc = "POLITICS_LORD_LINLITHGOW_DESC"
				#		picture = "gfx/leaders/RAJ/Portrait_The_Raj_Political_Leader_Generic_2.dds"
				#		expire = "1965.1.1"
				#		ideology = centrism
				#		traits = {
				#			
				#		}
				#	}
				#	create_country_leader = { #indian in japanese indian army but coulen't find better
				#		name = "Prem Sahgal"
				#		desc = "POLITICS_LORD_LINLITHGOW_DESC"
				#		picture = "gfx/leaders/RAJ/Portrait_The_Raj_Political_Leader_Generic_2.dds"
				#		expire = "1965.1.1"
				#		ideology = fascism_ideology
				#		traits = {
				#			
				#		}
				#	}						
				#													
				#}		

				#if = { #mal tag
				#	limit = {
				#		var:occupied_country = { 
				#			original_tag = MAL
				#			has_cosmetic_tag = MAL_UK
				#			is_puppet = no
				#		}
				#	}
				#	drop_cosmetic_tag = yes
				#}				
				
				set_temp_variable = { civil_war_country_picked = 0 }
				if = {
					## pick an existing civil war country
					limit = {
						FROM = {
							tag = PREV
						}
					}
					
					random_country_with_original_tag = {
						original_tag_to_check = var:occupier_country
						
						limit = {
							NOT = { tag = var:occupier_country }
							has_war_with = var:occupier_country
						}
						
						set_temp_variable = { civil_war_country_picked = 1 }
						set_temp_variable = { new_occupied_country = this }
					}
				}
				
				if = {
					## create a new country if necesarry
					limit = {
						check_variable = { civil_war_country_picked = 0 } 
						FROM = {
							#if resistance country exists and not at war with occupier (whitepaced/subjected etc) create a country instead
							exists = yes
							NOT = { has_war_with = occupier_country }
						}
					}
					create_dynamic_country = {
						original_tag = FROM
						copy_tag = FROM
						
						set_temp_variable = { new_occupied_country = THIS }
					}
				}				
				
				# change ideology if necessary
				if = {
					limit = { 
						var:occupied_country = {
							#only change ideology if we are not creating a new country and old country is not existing
							OR = {
								exists = no
								NOT = { tag = new_occupied_country }
							}
						}
					}
					
					# booleans that will be allowed to change ideology
					set_temp_variable = { allowed_party_neutrality = 1 }
					set_temp_variable = { allowed_party_democratic = 1 }
					set_temp_variable = { allowed_party_fascism = 1 }
					set_temp_variable = { allowed_party_communism = 1 }
					
					# do not change ideology of occupier country
					var:occupier_country = {
						remove_from_allowed_party = yes
					}
					
					if = {
						# if occupied country exists and different than new country
						# it is white peaced & subject of occupier. ignore its ideology as well
						limit = { NOT = { check_variable = { new_occupied_country = occupied_country } } }
						var:occupied_country = {
							remove_from_allowed_party = yes
						}
					}
					
					# change government if necessary , RT56 also check for autonomy
					var:new_occupied_country = {
						if = {
							limit = {
								is_puppet = yes
								OVERLORD = {
									has_capitulated = yes
								}
							}
							set_autonomy = {
								target = var:new_occupied_country
								autonomy_state = autonomy_free
							}						
						}
						if = {
							# check if our current ideology is OK
							limit = { 
								OR = {
									AND = {
										has_government = democratic
										check_variable = { allowed_party_democratic = 0 }
									}
									AND = {
										has_government = fascism
										check_variable = { allowed_party_fascism = 0 }
									}
									AND = {
										has_government = communism
										check_variable = { allowed_party_communism = 0 }
									}
									AND = { 
										has_government = neutrality
										check_variable = { allowed_party_neutrality = 0 }
									}
								}
							}
							
							random_list = {
								allowed_party_democratic = {
									set_popularities = {
										democratic = 100
									}
									set_politics = { ruling_party = democratic elections_allowed = yes }
								}
								allowed_party_fascism = {
									set_popularities = {
										fascism = 100
									}
									set_politics = { ruling_party = fascism elections_allowed = no }
								}
								allowed_party_communism = {
									set_popularities = {
										communism = 100
									}
									set_politics = { ruling_party = communism elections_allowed = no }
								}
								allowed_party_neutrality = {
									set_popularities = {
										neutrality = 100
									}
									set_politics = { ruling_party = neutrality elections_allowed = no }
								}
							}
						}
					}
				}
				
				# create resistance template for armies to spawn
				var:new_occupied_country = {
					if = {
						limit = { NOT = { has_country_flag = created_civil_war_template } }
						set_country_flag = created_civil_war_template
							
					#	division_template = {
					#		name = "Resistance"
					#		is_locked = yes
					#		regiments = {
					#			infantry = { x = 0 y = 0 }
					#			infantry = { x = 0 y = 1 }
					#
					#			infantry = { x = 1 y = 0 }
					#			infantry = { x = 1 y = 1 }
					#			
					#			infantry = { x = 2 y = 0 }
					#			infantry = { x = 2 y = 1 }
					#		}
					#	}
						if = {
							limit = {
								NOT = {
									has_tech = r56_militia_tech
								}
							}
							set_technology = r56_militia_tech
						}
						division_template = {
							name = "Resistance"
							is_locked = yes
							regiments = {
								militia = { x = 0 y = 0 }
								militia = { x = 0 y = 1 }
					
								militia = { x = 1 y = 0 }
								militia = { x = 1 y = 1 }
								
								militia = { x = 2 y = 0 }
								militia = { x = 2 y = 1 }
							}
						}					
					}
					every_state = {
						limit = {
							is_core_of = PREV.PREV
							has_resistance = yes
						}
						set_temp_variable = { new_compliance = compliance }
						multiply_temp_variable = { new_compliance = 0.75 }
						set_compliance = new_compliance						
						add_resistance_target = {
							amount = 20
						}						
					}
				}

			############## R56 CHECK AUTONOMY
				if = {
					limit = {
						var:new_occupied_country = {
							is_puppet = yes
							OVERLORD = {
								has_capitulated = yes
							}
						}

					}
					set_autonomy = {
						target = var:new_occupied_country
						autonomy_state = autonomy_free
					}						
				}				
				
				clear_temp_array = checked_neighbours
				every_controlled_state = {
					limit = { 
						occupied_country_tag = occupied_country 
						impassable = no
					}
					
					# move our armies to back home
					teleport_armies = {
						limit = { 
							OR = {
								is_ally_with = occupier_country
								has_military_access_to = occupier_country
							}
						}
						to_state_array = owned_controlled_states
					}
					
					# transfer state
					if = {
						limit = { has_resistance = yes }
						set_resistance = 0
					}
					var:new_occupied_country = {
						transfer_state = PREV
					}
					
					if = {
						limit = { 
							var:occupier_country = {
								check_variable = { resistance_already_inited@var:occupied_country = 0 } 
							}
						}
						
						# create resistance units, number is relative to size of industry
						set_temp_variable = { num_units_to_create = building_level@arms_factory }
						add_to_temp_variable = { num_units_to_create = building_level@industrial_complex } 
						divide_temp_variable = { num_units_to_create = 3 }
						add_to_temp_variable = { num_units_to_create = 2 }
						round_temp_variable = num_units_to_create
						clamp_temp_variable = { var = num_units_to_create min = 2 max = 6 }
						for_loop_effect = {
							end = num_units_to_create
							
							create_unit = {
								division = "division_template = \"Resistance\" start_experience_factor = 1 start_equipment_factor = 1"
								owner = new_occupied_country
							}
						}
					}
					
					# also check neighbouring core states of the occupier that are not captured yet
					# move our armies so they are not surrounded/create pockets
					every_neighbor_state = {
						limit = {
							is_owned_and_controlled_by = occupied_country
							is_core_of = occupied_country
							not = { is_in_array = { checked_neighbours = this } }
						}
						add_to_temp_array = { checked_neighbours = this }
						
						teleport_armies = {
							limit = { 
								OR = {
									is_ally_with = occupier_country
									has_military_access_to = occupier_country
								}
							}
							to_state_array = owned_controlled_states
						}
						
						set_state_province_controller = {
							controller = occupied_country
							limit = {
								is_ally_with = occupier_country
							}
						}
					}
				}
			
				# create war if necessary
				if = {
					limit = { NOT = { has_war_with = new_occupied_country } }
					declare_war_on = { target = new_occupied_country type = annex_everything }
				}
				
				var:occupier_country = {
					set_variable = { resistance_already_inited@var:occupied_country = 1 } 
				}
				
			}
			news_event = { id = r56.news_event.17 hours = 6 random_hours = 6 }
		}
	}
}
