############################################################################################################
#	Expert AI mod 
############################################################################################################

###### Garrison

EAI_enable_garrison_state_strategies = {

	if = {
		limit = {
			if = { limit = { has_war = yes }
				alliance_naval_strength_ratio < 3
			}
			else = { has_war = no }

			### exceptions

			# JAP needs troops vs CHi
			if = { limit = { tag = JAP }

				OR = {
					date > 1940.1.1
					alliance_naval_strength_ratio < 3
				}
			}
		}
		
		set_country_flag = EAI_enable_garrison_state_strategies
	}
	else = { clr_country_flag = EAI_enable_garrison_state_strategies }
}

###### Naval

EAI_track_submarine_losses = {

	subtract_from_variable = { EAI_previous_subs = num_ships_with_type@submarine }

	if = { limit = { check_variable = { EAI_previous_subs > 0 } }

		divide_variable = { EAI_previous_subs = num_ships_with_type@submarine }
		if = { limit = { check_variable = { EAI_previous_subs > 0.05 } } # lost more than 5%
			set_country_flag = { flag = EAI_halt_sub_missions value = 1 days = 14 }
		}
	}

	set_variable = { EAI_previous_subs = num_ships_with_type@submarine }
}

EAI_train_navy = { # simulate naval training for xp (AI doesn't exercise during war which causes serious issues for some like JAP later vs USA) - keep this for now

	@TRAINING_AVG_FUEL_CONSUMED_PER_SHIP = 32
	@TRAINING_AVG_XP_GAINED_PER_SHIP = 0.004

	if = {
		limit = {
			check_variable = { num_ships > 0 }

			has_navy_experience < 100

			fuel_ratio > 0.8

			has_war = yes

			enemies_naval_strength_ratio < 0.2 # enemy navies are very weak
			
			NOT = {
				any_enemy_country = {
					has_navy_size = { size > 10 }
				}
			}
		}

		set_temp_variable = { fuel_consumed = @TRAINING_AVG_FUEL_CONSUMED_PER_SHIP }
		multiply_temp_variable = { fuel_consumed = num_ships }
		multiply_temp_variable = { fuel_consumed = -1 }
		add_fuel = fuel_consumed

		set_temp_variable = { xp_gained = @TRAINING_AVG_XP_GAINED_PER_SHIP }
		multiply_temp_variable = { xp_gained = num_ships }
		navy_experience = xp_gained
	}
}

###### Air

EAI_calc_air_force_sizes = {

	### allied air size
		
	set_temp_variable = { friendly_air_force_size = num_fighters_deployed }

	for_each_scope_loop = { array = allies

		add_to_temp_variable = { friendly_air_force_size = num_fighters_deployed }
	}

	### enemies air size

	every_enemy_country = {

		set_temp_variable = { air_force_size_@THIS = num_fighters_deployed }

		if = { limit = { is_in_faction = yes NOT = { is_faction_leader = yes } }

			var:faction_leader = {

				add_to_temp_variable = { faction_air_force_size_@THIS = air_force_size_@PREV }
			}
		}
		
		else_if = { limit = { is_faction_leader = yes }

			add_to_temp_variable = { faction_air_force_size_@THIS = air_force_size_@THIS }
			add_to_temp_array = { enemy_air_force_sizes = THIS.id }
		}
		
		else = { add_to_temp_array = { enemy_air_force_sizes = THIS.id } }
	}
}

EAI_track_fighter_losses = { # monthly

	set_temp_variable = { EAI_previous_fighters_temp = EAI_previous_fighters }
	subtract_from_variable = { EAI_previous_fighters = num_fighters_deployed }
	set_variable = { EAI_monthly_fighters_lost_fraction = EAI_previous_fighters }

	if = { limit = { check_variable = { EAI_previous_fighters > 0 } }

		divide_variable = { EAI_monthly_fighters_lost_fraction = EAI_previous_fighters_temp }
	}
	else = {

		set_variable = { EAI_monthly_fighters_lost_fraction = 0 }
	}

	set_variable = { EAI_previous_fighters = num_fighters_deployed }
}

EAI_save_airforce_strategy = {

	if = { 
		limit = { 
			has_war = yes 
			has_capitulated = no
		}

		### Stop air missions when overwhelmed by enemy airforce

		if = { 
			limit = { 
				NOT = { has_country_flag = EAI_save_airforce_strategy }

				has_deployed_air_force_size = { size < 1000 type = fighter } 

				check_variable = { EAI_monthly_fighters_lost_fraction > 0.25 }
			}

			EAI_calc_air_force_sizes =  yes

			### Factions are grouped into one value under the faction leader, unallied countries are separate 

			for_each_scope_loop = { array = enemy_air_force_sizes

				if = { 
					limit = { 

						# Compare ROOT + allies against the enemy faction airforce
						if = { limit = { is_faction_leader = yes }

							set_temp_variable = { air_difference = faction_air_force_size_@THIS }
							subtract_from_temp_variable = { air_difference = friendly_air_force_size }

							set_temp_variable = { air_ratio = friendly_air_force_size }
							clamp_temp_variable = { var = faction_air_force_size_@THIS min = 1 }
							divide_temp_variable = { air_ratio = faction_air_force_size_@THIS }
						}

						# Compare ROOT + allies against the enemy country airforce
						else = {

							set_temp_variable = { air_difference = air_force_size_@THIS }
							subtract_from_temp_variable = { air_difference = friendly_air_force_size }

							set_temp_variable = { air_ratio = friendly_air_force_size }
							clamp_temp_variable = { var = air_force_size_@THIS min = 1 }
							divide_temp_variable = { air_ratio = air_force_size_@THIS }
						}

						check_variable = { air_difference > 800 } # enemy has > 800 fighters
						check_variable = { air_ratio < 0.25 } # ratio to enemy < 0.25
					}

					ROOT = { 
						set_country_flag = EAI_save_airforce_strategy
						set_country_flag = { flag = EAI_save_airforce_strategy_min_duration value = 1 days = 60 }
						# set_country_flag = EAI_anti_air_design_focus
						# clear_variable = EAI_no_surrender_progression_months

						if = { limit = { has_country_flag = EAI_military_strategy_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | AIR PRODUCTION: EAI_save_airforce_strategy" }
					}
				}
			}
		}

		### Resume

		else_if = { 
			limit = { 
				has_country_flag = EAI_save_airforce_strategy 
				
				NOT = { has_country_flag = EAI_save_airforce_strategy_min_duration }
			}

			### Has rebuilt its airforce

			if = { 
				limit = { 
					has_deployed_air_force_size = { size > 2000 type = fighter } 
				}

				clr_country_flag = EAI_save_airforce_strategy
				if = { limit = { has_country_flag = EAI_military_strategy_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | AIR PRODUCTION: discontinuing EAI_save_airforce_strategy" }
			}

			### Enemies weak

			else = {
				
				EAI_calc_air_force_sizes =  yes

				###

				for_each_scope_loop = { array = enemy_air_force_sizes

					# Compare ROOT + allies against the enemy faction airforce
					if = { limit = { is_faction_leader = yes }

						set_temp_variable = { air_difference = faction_air_force_size_@THIS }
						subtract_from_temp_variable = { air_difference = friendly_air_force_size }

						set_temp_variable = { air_ratio = friendly_air_force_size }
						clamp_temp_variable = { var = faction_air_force_size_@THIS min = 1 }
						divide_temp_variable = { air_ratio = faction_air_force_size_@THIS }
					}

					# Compare ROOT + allies against the enemy country airforce
					else = {

						set_temp_variable = { air_difference = air_force_size_@THIS }
						subtract_from_temp_variable = { air_difference = friendly_air_force_size }

						set_temp_variable = { air_ratio = friendly_air_force_size }
						clamp_temp_variable = { var = air_force_size_@THIS min = 1 }
						divide_temp_variable = { air_ratio = air_force_size_@THIS }
					}

					if = {
						limit = {
							OR = {
								check_variable = { air_difference > 400 }
								check_variable = { air_ratio < 0.30 }
							}
						}

						set_temp_variable = { break = 1 }
					}
				}

				if = { limit = { check_variable = { break = 0 } }

					clr_country_flag = EAI_save_airforce_strategy
					if = { limit = { has_country_flag = EAI_military_strategy_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | AIR PRODUCTION: discontinuing EAI_save_airforce_strategy" }
				}
			}
		}
	}

	else = { clr_country_flag = EAI_save_airforce_strategy }
}

###### Fronts

EAI_defensive_front_strategy = {

	if = { limit = { has_war = yes }

		### critically low on equipment

		if = { 
			limit = { 
				NOT = { has_country_flag = EAI_defensive_front_strategy_equipment }
				check_variable = { EAI_fielded_eq_ratio < 0.6 }
			}

			if = { limit = { NOT = { has_country_flag = EAI_defensive_front_strategy } }

				if = { limit = { has_country_flag = EAI_front_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | FRONT: stopping attacks due to low equipment" }
			}

			set_country_flag = EAI_defensive_front_strategy
			set_country_flag = EAI_defensive_front_strategy_equipment
		}
		else_if = {
			limit = {
				has_country_flag = EAI_defensive_front_strategy_equipment
				check_variable = { EAI_fielded_eq_ratio > 0.9 }
			}

			if = { limit = { has_country_flag = EAI_front_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | FRONT: CANCEL stopping attacks due to low equipment" }

			clr_country_flag = EAI_defensive_front_strategy
			clr_country_flag = EAI_defensive_front_strategy_equipment
		}

		### Out of manpower

		if = { 
			limit = {
				NOT = { has_country_flag = EAI_defensive_front_strategy_manpower }

				EAI_reserve_manpower_less_than_5p = yes
				
				OR = { # Can upgrade law or is currently conscripting
					EAI_can_upgrade_manpower_law = yes
					conscription_ratio < 1
				}
			}

			if = { limit = { NOT = { has_country_flag = EAI_defensive_front_strategy } }

				if = { limit = { has_country_flag = EAI_front_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | FRONT: stopping attacks due to low manpower" }
			}

			set_country_flag = EAI_defensive_front_strategy
			set_country_flag = EAI_defensive_front_strategy_manpower
		}
		else_if = {
			limit = {
				has_country_flag = EAI_defensive_front_strategy_manpower

				OR = { # Cancel if:
					EAI_reserve_manpower_more_than_10p = yes
					
					NOT = { # Cant upgrade law and not conscripting more
						EAI_can_upgrade_manpower_law = yes
						conscription_ratio < 1
					}
				}
			}

			if = { limit = { has_country_flag = EAI_front_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | FRONT: CANCEL stopping attacks due to low manpower" }

			clr_country_flag = EAI_defensive_front_strategy
			clr_country_flag = EAI_defensive_front_strategy_manpower
		}

		### weak vs countries

		every_enemy_country = {

			if = {
				limit = {
					ROOT = { 
						NOT = { is_in_array = { EAI_defensive_front_strategy_at = PREV.id } }

						alliance_strength_ratio < 0.5
						strength_ratio = { tag = PREV ratio < 0.25 }
					}
				}

				if = { limit = { has_country_flag = EAI_front_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | FRONT: stopping attacks vs [This.GetTag] (weak)" }

				ROOT = { add_to_array = { EAI_defensive_front_strategy_at = PREV.id } }
			}
			else_if = {
				limit = {
					ROOT = {
						is_in_array = { EAI_defensive_front_strategy_at = PREV.id }
					
						NOT = {
							alliance_strength_ratio < 0.5
							strength_ratio = { tag = PREV ratio < 0.25 }
						}
					}
				}

				if = { limit = { has_country_flag = EAI_front_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | FRONT: CANCEL stopping attacks vs [This.GetTag] (weak)" }

				ROOT = { remove_from_array = { EAI_defensive_front_strategy_at = PREV.id } }
			}
		}
	}
}

# Spaces out operational pause starts across countries so that every country doesn't pause on the same day
EAI_operational_pause_timer = { # Execute daily

    if = { 
        limit = { 
            has_war = yes

            NOT = { has_country_flag = EAI_operational_pause_timer_initialized }
        }

        random_list = {
            1 = { 
                set_country_flag = EAI_operational_pause_timer_initialized
            }
            60 = {}
        }
    }
    else_if = { 
        limit = { 
            has_war = no

            has_country_flag = EAI_operational_pause_timer_initialized
        }

        clr_country_flag = EAI_operational_pause_timer_initialized
    }

    if = { 
        limit = { 
            has_country_flag = EAI_operational_pause_timer_initialized

            NOT = { 
                has_country_flag = EAI_operational_pause_timer
                has_country_flag = EAI_operational_resume_timer
            }
        }

		@PAUSE_DURATION_BASE = 7
		@PAUSE_DURATION_MAX_ADDED = 7
        
        set_temp_variable = { pause_duration = @PAUSE_DURATION_MAX_ADDED }
        multiply_temp_variable = { pause_duration = random }
        add_to_temp_variable = { pause_duration = @PAUSE_DURATION_BASE }
        round_temp_variable = pause_duration

		@RESUME_DURATION_BASE = 60
		@RESUME_DURATION_ADDED = 40
        
        set_temp_variable = { resume_duration = @RESUME_DURATION_ADDED }
        multiply_temp_variable = { resume_duration = random }
        add_to_temp_variable = { resume_duration = @RESUME_DURATION_BASE }
        round_temp_variable = resume_duration 
        add_to_temp_variable = { resume_duration = pause_duration }

		@INITIAL_RESUME_DURATION_BASE = 7

		set_temp_variable = { initial_resume_duration = @INITIAL_RESUME_DURATION_BASE }
		add_to_temp_variable = { initial_resume_duration = pause_duration }

        meta_effect = {
            text = { 
                set_country_flag = { flag = EAI_operational_pause_timer value = 1 days = [x] }
                set_country_flag = { flag = EAI_operational_initial_resume_timer value = 1 days = [z] }
                set_country_flag = { flag = EAI_operational_resume_timer value = 1 days = [y] }
            }
            x = "[?pause_duration]"
            y = "[?resume_duration]"
            z = "[?initial_resume_duration]"
        }
        if = { limit = { has_country_flag = EAI_military_strategy_logging }  log = "[GetYear] [GetMonth] | AI | [Root.GetName] | EAI_operational_pause_timer [?pause_duration] [?resume_duration] [?initial_resume_duration]" }
    }
}

###

EAI_special_military_strategies = { # Weekly

	EAI_GER_offensive_vs_SOV_is_weak = yes

	EAI_SOV_offensive_vs_GER_is_weak = yes

	EAI_JAP_push_CHI_north = yes
}

### Barbarossa

EAI_GER_offensive_vs_SOV_is_weak = {

	if = {
		limit = {
			NOT = { has_country_flag = EAI_GER_offensive_vs_SOV_is_weak }
			NOT = { has_country_flag = EAI_GER_offensive_vs_SOV_is_weak_timeout }

			###

			has_war_with = SOV

			is_in_faction_with = GER

			check_variable = { EAI_fielded_eq_ratio > 0.7 }
			EAI_reserve_manpower_more_than_25p = yes

			SOV = {
				OR = {
					surrender_progress > 0.8
					strength_ratio = { tag = PREV ratio < 0.5 } 

					check_variable = { EAI_fielded_eq_ratio < 0.6 }
					EAI_reserve_manpower_less_than_5p = yes
				}
			}
		}

		set_country_flag = { flag = EAI_GER_offensive_vs_SOV_is_weak value = 1 days = 30 }
		set_country_flag = { flag = EAI_lift_airforce_restriction value = 1 days = 30 }

		set_country_flag = { flag = EAI_GER_offensive_vs_SOV_is_weak_timeout value = 1 days = 120 }
	}

	else_if = {
		limit = {
			has_country_flag = EAI_GER_offensive_vs_SOV_is_weak

			###

			NOT = {
				AND = {
					check_variable = { EAI_fielded_eq_ratio > 0.6 }

					SOV = {
						OR = {
							surrender_progress > 0.8
							strength_ratio = { tag = GER ratio < 0.5 } 

							check_variable = { EAI_fielded_eq_ratio < 0.6 }
							EAI_reserve_manpower_less_than_10p = yes
						}
					}
				}
			}
		}

		clr_country_flag = EAI_GER_offensive_vs_SOV_is_weak
		clr_country_flag = EAI_lift_airforce_restriction
	}
}

EAI_SOV_offensive_vs_GER_is_weak = {

	if = {
		limit = {
			NOT = { has_country_flag = EAI_SOV_offensive_vs_GER_is_weak }
			NOT = { has_country_flag = EAI_SOV_offensive_vs_GER_is_weak_timeout }

			###

			has_war_with = GER

			is_in_faction_with = SOV

			check_variable = { EAI_fielded_eq_ratio > 0.7 }

			GER = {
				OR = {
					surrender_progress > 0.8
					strength_ratio = { tag = SOV ratio < 0.5 } 

					check_variable = { EAI_fielded_eq_ratio < 0.6 }
					EAI_reserve_manpower_less_than_5p = yes
				}
			}
		}

		set_country_flag = { flag = EAI_SOV_offensive_vs_GER_is_weak value = 1 days = 30 }
		set_country_flag = { flag = EAI_lift_airforce_restriction value = 1 days = 30 }

		set_country_flag = { flag = EAI_SOV_offensive_vs_GER_is_weak_timeout value = 1 days = 120 }
	}

	else_if = {
		limit = {
			has_country_flag = EAI_SOV_offensive_vs_GER_is_weak

			###

			NOT = {
				AND = {
					check_variable = { EAI_fielded_eq_ratio > 0.6 }

					GER = {
						OR = {
							surrender_progress > 0.8
							strength_ratio = { tag = SOV ratio < 0.5 }

							check_variable = { EAI_fielded_eq_ratio < 0.6 }
							EAI_reserve_manpower_less_than_10p = yes 
						}
					}
				}
			}
		}

		clr_country_flag = EAI_SOV_offensive_vs_GER_is_weak
		clr_country_flag = EAI_lift_airforce_restriction
	}
}

### Japan vs China

EAI_JAP_push_CHI_north = {

	if = {
		limit = {
			tag = JAP
			has_war_with = CHI
		}

		if = { # There was an issue with JAP not launching any invasions, so make it push north as fallback
			limit = {
				NOT = {
					any_state = {
						is_coastal = yes
						OR = {
							region = 247
							region = 164
							region = 248
							state = 597
						}
						OR = {
							JAP = { divisions_in_state = { state = PREV size > 0 } }
							is_controlled_by = JAP
						}
					}
				}
			}

			add_to_variable = { EAI_JAP_push_CHI_north_days_since_invasion = 7 }
		}
		else = {
			set_variable = { EAI_JAP_push_CHI_north_days_since_invasion = 0 }
		}
	}
}