on_actions = {

	# called when an operative performing an offensive mission in a country
	# has been spotted
	on_operative_on_mission_spotted = {

		effect = {
            # SCOPE  the operative
            # ROOT   the country the operative was performing its mission in
            # FROM   the country the operative is operating for

			# base values
            set_temp_variable = {
                var = capture_chance
                value = 90
            }
            set_temp_variable = {
                var = kill_chance
                value = 10
            }			

            # nullify kill chance for some missions
            if = {
                limit = {
                    OR = {
                        operative_leader_mission = control_trade
						operative_leader_mission = diplomatic_pressure
                    }
                }
                set_temp_variable = {
                    var = kill_chance
                    value = 0
                }
            }
			if = {
                limit = {

					is_operation_type = operation_targeted_plant_false_new_order_intel
					FROM = {
						OR = {
							tag = ENG
							is_in_faction_with = ENG
						}
						
					}
					
                }
				add_opinion_modifier = {
					target = ENG
					modifier = medium_decrease
				}
			}
			if = {
                limit = {
					is_operation_type = operation_targeted_plant_false_new_order_intel
					FROM = {
						is_faction_leader = yes
						NOT = {
							tag = ENG
						}
					}
					
                }
				add_opinion_modifier = {
					target = FROM
					modifier = medium_decrease
				}
            }			
            # Capture chance modifier unused as it would just increased or decrease death chance
            #multiply_temp_variable = {
            #   var = capture_chance
            #   value = own_capture_chance_factor # the operative's capture chance modifiers
            #}
            #clamp_temp_variable = {
            #   var = capture_chance
            #   min = 0
            #   max = 100
            #}

            random_list = {
                #log = yes # log picked effect in game.log

                temp_var:capture_chance = {
                   	capture_operative = {
                   	    captured_by = ROOT
                   	}  	
                }
                temp_var:kill_chance = {
                    kill_operative = {
                        killed_by = ROOT
                    }
                }

            }

        }
        
    }

	on_operative_captured = {
		effect = {
			# SCOPE  the operative
			# ROOT   the country the operative was performing its mission in
			# FROM   the country the operative is operating for
			operative_leader_event = {
					id = lar_operative_event.6
					recipient = ROOT
					originator = ROOT
					set_from_from = ROOT
					set_from = FROM
					days = 1
			}
			if = {
				limit = {
					NOT = { has_unit_leader_flag = le_clerc1 }
				}
				set_unit_leader_flag = le_clerc1
			}
			else_if = {
				limit = {
					has_unit_leader_flag = le_clerc1
				}
				set_unit_leader_flag = le_clerc2
			}
			random_list = {
				log = yes
				90 = { #regular
					operative_leader_event = {
						id = lar_operative_event.1
						set_from_from = ROOT
					}
				}
				10 = { #operative turned
					modifier = {
						has_trait = operative_tough
						factor = 0 #tough operatives never get turned
					}
					modifier = {
						has_trait = operative_double_agent
						factor = 0 #no tripple agents please
					}
					turn_operative = { turned_by = ROOT }
					# ensure the operative has the nationality of the country he is coming from
					add_nationality = FROM
					operative_leader_event = {
            	    	id = lar_operative_event.5
						set_from_from = FROM #tells the event which nationality to add
            		}
            	}
			}
		}
	}

	on_operative_death = {
		effect = {
			# SCOPE  the operative
			# ROOT   the killer country (optional)
			# FROM   the country the operative is operating for
			if = {
				limit = {
					country_exists = ROOT
				}

				# operative killed by a country, likelly while on mission
				operative_leader_event = {
					id = lar_operative_event.3
					set_from_from = ROOT
				}
			}
			else = {
				# other cause of death
			}
			
			if = {
				limit = {
					FROM = {
						NOT = { is_ai = yes }
						has_done_agency_upgrade = upgrade_suicide_pills
					}
				}
				set_global_flag = kill_me_alive_flag
			}
		}
	}
	
	# SCOPE_UNIT_LEADER [
	#	ROOT, FROM
	#	FROM.FROM : SCOPE_STATE ( will only be set if the operation has a specific selection_target )
	# ]
	on_operative_detected_during_operation = {
		effect = {
			random_list = {
				40 = {
					force_operative_leader_into_hiding = 45
					operative_leader_event = {
						id = lar_operative_event.2
						set_from_from = FROM
					}
				}
				35 = {
					capture_operative = {
						captured_by = FROM
					}
				}
				20 = {
					harm_operative_leader = 90
					operative_leader_event = {
						id = lar_operative_event.4
						set_from_from = FROM
					}
				}
				5 = {
					kill_operative = {
						killed_by = FROM
					}
				}
			}
		}
	}

	on_operation_completed = {
		effect = {
			# same scope setup as in operation outcome:
			# THIS: the operation
			# ROOT: the initiating country
			# FROM: the target country
			#log = "This: [This.GetName] From: [From.GetName] Root: [Root.GetName]"
			
			if = {
				limit = {
					ROOT = { has_country_flag = just_freed_operative_flag }
				}
				every_operative = {
					if = {
						limit = {
							NOT = { has_trait = operative_escape_artist }
						}
						random_list = {
							15 = { add_unit_leader_trait = operative_escape_artist }
							85 = {}
						}
					}
				}
				ROOT = { clr_country_flag = just_freed_operative_flag }
			}
			every_operative = { #add target nationality if linguist
				if = {
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission } this line from the base game just break the thing
						NOT = { has_nationality = FROM }
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
						
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}

				if = { #Second nationality roll if you already know arabic
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = IRQ
								original_tag = SAU
								original_tag = YEM
								original_tag = OMA
								original_tag = EGY
								original_tag = LBA
								original_tag = JOR
								original_tag = PAL
								original_tag = LEB
								original_tag = SYR
								original_tag = KUW
								original_tag = UAE
								original_tag = QAT
								original_tag = ALG
								original_tag = MOR
							}							
						}
						OR = {
							has_nationality = IRQ
							has_nationality = SAU
							has_nationality = YEM
							has_nationality = OMA
							has_nationality = EGY
							has_nationality = LBA
							has_nationality = JOR
							has_nationality = PAL
							has_nationality = LEB
							has_nationality = SYR
							has_nationality = KUW
							has_nationality = UAE
							has_nationality = QAT
							has_nationality = ALG
							has_nationality = MOR
						}						
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
					}
					random_list = {
						10 = { add_nationality = FROM }
						90 = {}
					}
				}
				if = { #Second nationality roll if you already know Spanish
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = SPR
								original_tag = PRU
								original_tag = ARG
								original_tag = CHL
								original_tag = URG
								original_tag = COL
								original_tag = ECU
								original_tag = VEN
								original_tag = PAN
								original_tag = MEX
								original_tag = ELS
								original_tag = NIC
								original_tag = HON
								original_tag = BLZ
								original_tag = COS
								original_tag = CUB
								original_tag = DOM
								original_tag = PUE
							}							
						}
						OR = {
							has_nationality = SPR
							has_nationality = PRU
							has_nationality = ARG
							has_nationality = CHL
							has_nationality = URG
							has_nationality = COL
							has_nationality = ECU
							has_nationality = VEN
							has_nationality = PAN
							has_nationality = MEX
							has_nationality = ELS
							has_nationality = NIC
							has_nationality = HON
							has_nationality = BLZ
							has_nationality = COS
							has_nationality = CUB
							has_nationality = DOM
							has_nationality = PUE							
						}						
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
					}
					random_list = {
						10 = { add_nationality = FROM }
						90 = {}
					}
				}
				if = { #Second nationality roll if you already know Portuguese
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = GNB
								original_tag = POR
								original_tag = BRA
								original_tag = ANG
								original_tag = MZB
							}							
						}
						OR = {

							has_nationality = GNB
							has_nationality = POR
							has_nationality = BRA
							has_nationality = ANG
							has_nationality = MZB							
						}						
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
					}
					random_list = {
						10 = { add_nationality = FROM }
						90 = {}
					}
				}
				if = { #Second nationality roll if you already know English
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = ENG
								original_tag = SCO
								original_tag = NIR
								original_tag = IRE
								original_tag = USA
								original_tag = CAN
								original_tag = SAF
								original_tag = AST
								original_tag = NZL
								original_tag = BAS
								original_tag = WLS
							}							
						}
						OR = {
							has_nationality = ENG
							has_nationality = SCO
							has_nationality = NIR
							has_nationality = IRE
							has_nationality = USA
							has_nationality = CAN
							has_nationality = SAF
							has_nationality = AST
							has_nationality = NZL
							has_nationality = BAS
							has_nationality = WLS														
						}						
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
					}
					random_list = {
						10 = { add_nationality = FROM }
						90 = {}
					}
				}
				if = { #Second nationality roll if you already know Dutch
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = SAF
								original_tag = HOL
								original_tag = BEL
								original_tag = VLA
								original_tag = SUR
								original_tag = CRC								
							}							
						}
						OR = {
							has_nationality = SAF
							has_nationality = HOL
							has_nationality = BEL
							has_nationality = VLA
							has_nationality = SUR
							has_nationality = CRC							
						}						
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
					}
					random_list = {
						10 = { add_nationality = FROM }
						90 = {}
					}
				}
				if = { #Second nationality roll if you already know French
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = FRA
								original_tag = WLL
								original_tag = BEL
								original_tag = QBC
								original_tag = OCC
								original_tag = CAY	
								original_tag = GDL							
							}							
						}
						OR = {
							has_nationality = FRA
							has_nationality = WLL
							has_nationality = BEL
							has_nationality = QBC
							has_nationality = OCC
							has_nationality = GDL
							has_nationality = CAY													
						}						
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
					}
					random_list = {
						10 = { add_nationality = FROM }
						90 = {}
					}
				}
				if = { #Second nationality roll if you already know Greek
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = CYP	
								original_tag = GRE							
							}							
						}
						OR = {
							has_nationality = GRE
							has_nationality = CYP													
						}						
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
					}
					random_list = {
						10 = { add_nationality = FROM }
						90 = {}
					}
				}
				if = { #Second nationality roll if you already know Romanian
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = ROM	
								original_tag = MOL							
							}							
						}
						OR = {
							has_nationality = MOL
							has_nationality = ROM													
						}						
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
					}
					random_list = {
						10 = { add_nationality = FROM }
						90 = {}
					}
				}				
				if = { #Second nationality roll if you already know serbo-croat
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = YUG
								original_tag = SER
								original_tag = BOS
								original_tag = HRZ
								original_tag = CRO
								original_tag = MNT						
							}							
						}
						OR = {
							has_nationality = YUG
							has_nationality = SER
							has_nationality = BOS
							has_nationality = HRZ
							has_nationality = CRO
							has_nationality = MNT													
						}						
						ROOT = {
							NOT = { has_country_flag = upgrade_linguistic_training_flag }
						}
					}
					random_list = {
						10 = { add_nationality = FROM }
						90 = {}
					}
				}																																				
				if = {
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						30 = { add_nationality = FROM }
						70 = {}
					
					}
				}
				if = { #Second nationality roll if you already know arabic
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = IRQ
								original_tag = SAU
								original_tag = YEM
								original_tag = OMA
								original_tag = EGY
								original_tag = LBA
								original_tag = JOR
								original_tag = PAL
								original_tag = LEB
								original_tag = SYR
								original_tag = KUW
								original_tag = UAE
								original_tag = QAT
								original_tag = ALG
								original_tag = MOR
							}							
						}
						OR = {
							has_nationality = IRQ
							has_nationality = SAU
							has_nationality = YEM
							has_nationality = OMA
							has_nationality = EGY
							has_nationality = LBA
							has_nationality = JOR
							has_nationality = PAL
							has_nationality = LEB
							has_nationality = SYR
							has_nationality = KUW
							has_nationality = UAE
							has_nationality = QAT
							has_nationality = ALG
							has_nationality = MOR
						}						
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}
				if = { #Second nationality roll if you already know Spanish
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = SPR
								original_tag = PRU
								original_tag = ARG
								original_tag = CHL
								original_tag = URG
								original_tag = COL
								original_tag = ECU
								original_tag = VEN
								original_tag = PAN
								original_tag = MEX
								original_tag = ELS
								original_tag = NIC
								original_tag = HON
								original_tag = BLZ
								original_tag = COS
								original_tag = CUB
								original_tag = DOM
								original_tag = PUE
							}							
						}
						OR = {

							has_nationality = SPR
							has_nationality = PRU
							has_nationality = ARG
							has_nationality = CHL
							has_nationality = URG
							has_nationality = COL
							has_nationality = ECU
							has_nationality = VEN
							has_nationality = PAN
							has_nationality = MEX
							has_nationality = ELS
							has_nationality = NIC
							has_nationality = HON
							has_nationality = BLZ
							has_nationality = COS
							has_nationality = CUB
							has_nationality = DOM	
							has_nationality = PUE						
						}						
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}
				if = { #Second nationality roll if you already know Portuguese
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = GNB
								original_tag = POR
								original_tag = BRA
								original_tag = ANG
								original_tag = MZB
							}							
						}
						OR = {

							has_nationality = GNB
							has_nationality = POR
							has_nationality = BRA
							has_nationality = ANG
							has_nationality = MZB							
						}						
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}
				if = { #Second nationality roll if you already know English
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = ENG
								original_tag = SCO
								original_tag = NIR
								original_tag = IRE
								original_tag = USA
								original_tag = CAN
								original_tag = SAF
								original_tag = AST
								original_tag = NZL
								original_tag = BAS
								original_tag = WLS
							}							
						}
						OR = {
							has_nationality = ENG
							has_nationality = SCO
							has_nationality = NIR
							has_nationality = IRE
							has_nationality = USA
							has_nationality = CAN
							has_nationality = SAF
							has_nationality = AST
							has_nationality = NZL
							has_nationality = BAS
							has_nationality = WLS														
						}						
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}
				if = { #Second nationality roll if you already know Dutch
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = SAF
								original_tag = HOL
								original_tag = BEL
								original_tag = VLA
								original_tag = SUR
								original_tag = CRC								
							}							
						}
						OR = {
							has_nationality = SAF
							has_nationality = HOL
							has_nationality = BEL
							has_nationality = VLA
							has_nationality = SUR
							has_nationality = CRC							
						}						
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}
				if = { #Second nationality roll if you already know French
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = FRA
								original_tag = WLL
								original_tag = BEL
								original_tag = QBC
								original_tag = OCC
								original_tag = CAY	
								original_tag = GDL							
							}							
						}
						OR = {
							has_nationality = FRA
							has_nationality = WLL
							has_nationality = BEL
							has_nationality = QBC
							has_nationality = OCC
							has_nationality = GDL
							has_nationality = CAY													
						}						
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}
				if = { #Second nationality roll if you already know Greek
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = CYP	
								original_tag = GRE							
							}							
						}
						OR = {
							has_nationality = GRE
							has_nationality = CYP													
						}						
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}
				if = { #Second nationality roll if you already know Romanian
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = ROM	
								original_tag = MOL							
							}							
						}
						OR = {
							has_nationality = ROM
							has_nationality = MOL													
						}						
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}				
				if = { #Second nationality roll if you already know serbo-croat
					limit = {
						has_trait = operative_linguist
					#	NOT = { operative_leader_mission = no_mission }
						NOT = { has_nationality = FROM }
						FROM = {
							OR = {
								original_tag = YUG
								original_tag = SER
								original_tag = BOS
								original_tag = HRZ
								original_tag = CRO
								original_tag = MNT						
							}							
						}
						OR = {
							has_nationality = YUG
							has_nationality = SER
							has_nationality = BOS
							has_nationality = HRZ
							has_nationality = CRO
							has_nationality = MNT													
						}						
						ROOT = {
							has_country_flag = upgrade_linguistic_training_flag
						}
					}
					random_list = {
						20 = { add_nationality = FROM }
						80 = {}
					}
				}																																								
			}
			every_operative = {
				if = {
					limit = {
						has_nationality = FRA
					}
					ROOT = {
						add_to_variable = {
							var = fra_nat
							value = 1
						}
					}
				}
				if = {
					limit = {
						has_nationality = ENG
					}
					ROOT = {
						add_to_variable = {
							var = eng_nat
							value = 1
						}
					}
				}
			}
			ROOT = {
				if = {
					limit = {
						check_variable = { fra_nat > 0 }
						check_variable = { eng_nat > 0 }
					}
					set_country_flag = achievement_listen_carefully_flag
				}
				set_variable = {
					var = fra_nat
					value = 0
				}
				set_variable = {
					var = eng_nat
					value = 0
				}
			}
		}
	}

	on_startup = {
		effect = {
			SPR = {
				if = {
					limit = {
						date < 1936.1.2
						AND = {
							has_dlc = "La Resistance"
							NOT = {
								has_game_rule = {
									rule = SPR_focus_tree_selection
									option = R56_TREE
								}
							}
						}
					}
					country_lock_all_division_template = yes
					every_state = {
						limit = {
							is_core_of = SPR
						}
						remove_core_of = SPA
						remove_core_of = SPB
						remove_core_of = SPC
					}
					if = {
						limit = {
							difficulty > 1
							is_ai = no
						}
						SPR = {
							add_to_variable = { var = spa_civil_war_divisions_counter_var value = 7 }
						}
					}
				}
				if = {
					limit = {
						date > 1939.1.1
						AND = {
							has_dlc = "La Resistance"
							NOT = {
								has_game_rule = {
									rule = SPR_focus_tree_selection
									option = R56_TREE
								}
							}
						}
					}
					every_state = {
						limit = {
							is_core_of = SPR
						}
						remove_core_of = SPD
						remove_core_of = SPB
						remove_core_of = SPC
						remove_core_of = d01
					}
					every_state = {
						limit = {
							OR = {
								state = 41
								state = 165
								state = 167
								state = 168
								state = 173
								state = 175
								state = 790
								state = 792
								state = 793
								state = 794
							}
						}
						remove_core_of = SPA
						start_resistance = yes
					}
				}
			}
		}
	}

	# ROOT is capitulated country, FROM is winner
	on_capitulation = {
		effect = {
		}
	}

	# called a country fully decrypts cipher of a target country
	# scope is the target country that its cipher is decrypted
	# from scope is the decrypter country
	on_fully_decrypted_cipher = {

	}

	# called when a country activates its active cipher bonuses against a target
	# scope is the target country
	# from scope is the country that activates its bonuses
	on_activated_active_decryption_bonuses = {

	}

	#FROM is the one that joins the faction
	on_create_faction = {
		effect = {
			# SPA Iberian Pact - either POR or SPA join a faction - the other must be added too.
			if = {
				limit = {
					has_country_flag = SPA_iberian_pact
				}
				save_event_target_as = iberian_pact_invitee
				every_other_country = {
					limit = {
						OR = {
							original_tag = POR
							original_tag = SPA
						}
						has_country_flag = SPA_iberian_pact
						NOT = { is_in_faction_with = ROOT }
						NOT = { is_in_faction = yes }
					}
					country_event = lar_spain.28
				}
			}
		}
	}

	#FROM is faction leader on join faction requests. THIS DOES NOT FIRE ON ADD_TO_FACTION EFFECT! USE ON_OFFER_JOIN_FACTION!
	on_join_faction = {
		effect = {
			# SPA Iberian Pact - either POR or SPA join a faction - the other must be added too.
			if = {
				limit = {
					has_country_flag = SPA_iberian_pact
				}
				set_country_flag = SPA_iberian_pact_invitee
				FROM = { set_country_flag = SPA_iberian_pact_faction_leader }
				every_other_country = {
					limit = {
						OR = {
							original_tag = POR
							original_tag = SPA
						}
						has_country_flag = SPA_iberian_pact
						is_in_faction = no
					}
					country_event = lar_spain.28
				}
			}
		}
	}

	#FROM is country getting invited.
	on_offer_join_faction = {
		effect = {
			# SPA Iberian Pact - either POR or SPA join a faction - the other must be added too.
			if = {
				limit = {
					FROM = { has_country_flag = SPA_iberian_pact }
				}
				set_country_flag = SPA_iberian_pact_faction_leader
				FROM = { set_country_flag = SPA_iberian_pact_invitee }
				every_country = {
					limit = {
						OR = {
							original_tag = POR
							original_tag = SPA
						}
						has_country_flag = SPA_iberian_pact
						NOT = { tag = FROM }
						is_in_faction = no
					}
					#country_event = lar_spain.28
					country_event = { id = lar_spain.28 hours = 1 }
				}
			}
		}
	}

	# called when a country send volunteers to another
	# ROOT is sender, FROM is receiver
	on_send_volunteers = {
		effect = {
			if = {
				limit = {
					SPR_scw_in_progress = yes
					FROM = { tag = SPA }
				}
				set_country_flag = SPR_sent_volunteers_to_SPA_flag
			}
			if = {
				limit = {
					SPR_scw_in_progress = yes
					FROM = { tag = SPD }
				}
				set_country_flag = SPR_sent_volunteers_to_SPD_flag
			}
		}
	}

	#FROM is war target
	on_declare_war = {
		effect = {
			if = {
				limit = {
					tag = SPA
					FROM = {
						tag = SPD
					}
				}
				every_unit_leader = {
					limit = {
						has_unit_leader_flag = SPR_reassigned_flag
					}
					add_timed_unit_leader_trait = {
						trait = reassigned
						days = 60
					}
				}
			}
			# SPA Iberian Pact - either POR or SPA join a war - the other must join too.
			if = {
				limit = {
					has_country_flag = SPA_iberian_pact
					FROM = { NOT = { has_country_flag = SPA_iberian_pact } }
				}
				hidden_effect = {
					FROM = { set_country_flag = SPA_iberian_pact_enemy_flag }
				}
				every_other_country = {
					limit = {
						OR = {
							original_tag = POR
							original_tag = SPA
						}
						has_country_flag = SPA_iberian_pact
					}
					country_event = lar_spain.29
				}
			}
			else_if = {
				limit = {
					NOT = { has_country_flag = SPA_iberian_pact }
			 		FROM = { has_country_flag = SPA_iberian_pact }
				}
				hidden_effect = {
					set_country_flag = SPA_iberian_pact_enemy_flag
				}
				every_country = {
					limit = {
						OR = {
							original_tag = POR
							original_tag = SPA
						}
						has_country_flag = SPA_iberian_pact
						NOT = { tag = FROM }
					}
					country_event = lar_spain.29
				}
			}
			#Clean up Franco in case of double Franco
			hidden_effect = {
				while_loop_effect = {
					limit = {
						has_country_leader = {
							name = "Francisco Franco"
							ruling_only = yes
						}
						FROM = {
							has_country_leader = {
								name = "Francisco Franco"
								ruling_only = yes
							}
						}
					}
					retire_country_leader = yes
				}
				#Clean up Mola in case of double Mola
				while_loop_effect = {
					limit = {
						has_country_leader = {
							name = "Emilio Mola"
							ruling_only = yes
						}
						FROM = {
							has_country_leader = {
								name = "Emilio Mola"
								ruling_only = yes
							}
						}
					}
					retire_country_leader = yes
				}
				#Clean up Primo de Rivera in case of already dead
				if = {
					limit = {
						has_country_leader = {
							name = "José Antonio Primo de Rivera"
							ruling_only = yes
						}
						FROM = {
							has_completed_focus = SPA_martyrdom_for_primo_de_rivera
						}
					}
					retire_country_leader = yes
				}
			}
		}
	}
	#ROOT is winner #FROM gets annexed - This fires just before FROM gets annexed, meaning the country and everything it owns still exists. It will also fire on_annex and on_civil_war_end
	on_civil_war_end_before_annexation = {
		effect = {
			if = { # Nationalist victory SCW
				limit = {
					FROM = {
						original_tag = SPR
					}
					has_completed_focus = SPA_a_great_spain
					SPR_scw_in_progress = yes
					NOT = {
						has_global_flag = SPR_carlist_uprising_flag
						has_completed_focus = SPA_fuse_the_parties
					}
					NOT = {
						any_other_country = {
							NOT = {
								tag = ROOT
								tag = FROM
							}
							original_tag = SPR
							exists = yes
						}
					}
				}
				country_event = { id = lar_news.28 }
			}
			if = { # Republican victory SCW
				limit = {
					FROM = {
						original_tag = SPR
					}
					has_completed_focus = SPR_the_popular_front
					SPR_scw_in_progress = yes
					NOT = { has_global_flag = SPR_anarchist_uprising_flag }
					NOT = {
						any_other_country = {
							NOT = {
								tag = ROOT
								tag = FROM
							}
							original_tag = SPR
							exists = yes
						}
					}
				}
				country_event = { id = lar_news.29 }
			}
			if = { # Nationalist victory SCW
				limit = {
					FROM = {
						original_tag = SPR
					}
					has_completed_focus = SPA_a_great_spain
					SPR_scw_in_progress = yes
					OR = {
						has_global_flag = SPR_carlist_uprising_flag
						has_completed_focus = SPA_fuse_the_parties
					}
					NOT = {
						any_other_country = {
							NOT = {
								tag = ROOT
								tag = FROM
							}
							original_tag = SPR
							exists = yes
						}
					}
				}
				country_event = { id = lar_news.1 }
				set_global_flag = nationalist_victory
				set_global_flag = scw_over
			}
			if = { # Republican victory SCW
				limit = {
					FROM = {
						original_tag = SPR
					}
					has_completed_focus = SPR_the_popular_front
					SPR_scw_in_progress = yes
					has_global_flag = SPR_anarchist_uprising_flag
					NOT = {
						any_other_country = {
							NOT = {
								tag = ROOT
								tag = FROM
							}
							original_tag = SPR
							exists = yes
						}
					}
				}
				country_event = { id = lar_news.2 }
				set_global_flag = republican_victory
				set_global_flag = scw_over
				if = { #If SPD has Portuguese mutineers, send them back
					limit = {
						tag = SPD
						has_country_flag = POR_got_portuguese_mutineers_flag
					}
					POR = { country_event = { id = lar_portugal_navy_mutiny.5 days = 5 random_days = 3 } }
				}
			}
			if = { # Remove Portuguese "Volunteers in the War" National Spirit
				limit = { 
					original_tag = SPR
					has_global_flag = scw_over
				}
				POR = {
					if = {
						limit = {
							has_idea = POR_volunteers_in_the_war_nationalist
						}
						remove_ideas = POR_volunteers_in_the_war_nationalist
					}
					else_if = {
						limit = {
							has_idea = POR_volunteers_in_the_war_republican
						}
						remove_ideas = POR_volunteers_in_the_war_republican
					}
					else_if = {
						limit = {
							has_idea = POR_volunteers_in_the_war_carlist
						}
						remove_ideas = POR_volunteers_in_the_war_carlist
					}
				}
			}
		}
	}

	#ROOT is winner #FROM gets annexed - This will also fire on_annex
	on_civil_war_end = {
		effect = {
			# give French focus tree to French communists if they win one of their civil wars (we have several now)
			if = {
				limit = {
					original_tag = FRA
					has_government = communism
					has_focus_tree = generic_focus
					FROM = {
						original_tag = FRA
						NOT = { has_government = communism }
					}
				}
				load_focus_tree = { tree = french_focus keep_completed = no }
				complete_national_focus = FRA_radicalize_front
				if = {
					limit = {
						has_country_leader = {
							ruling_only = yes
							name = "Léon Jouhaux"
						}
					}
					unlock_national_focus = FRA_work_with_the_cgt
				}
				else = {
					unlock_national_focus = FRA_pcf_sfio_coalition
				}
			}
			if = {
				limit = {
					original_tag = FRA
					has_government = fascism
					has_focus_tree = generic_focus
					FROM = {
						original_tag = FRA
						NOT = { has_government = fascism }
					}
				}
				load_focus_tree = { tree = french_focus keep_completed = no }
				complete_national_focus = FRA_far_right_leagues
				complete_national_focus = FRA_front_liberte
				unlock_national_focus = FRA_support_ppf
			}
			if = {
				limit = {
					original_tag = FRA
					has_government = democratic
					has_focus_tree = generic_focus
					FROM = {
						original_tag = FRA
						NOT = { has_government = democratic }
					}
				}
				load_focus_tree = { tree = french_focus keep_completed = no }
				complete_national_focus = FRA_status_quo
			}
			if = {
				limit = {
					original_tag = FRA
					has_government = neutrality
					has_focus_tree = generic_focus
					FROM = {
						original_tag = FRA
						NOT = { has_government = neutrality }
					}
				}
				load_focus_tree = { tree = french_focus keep_completed = no }
				complete_national_focus = FRA_action_francaise
			}
			# Give back POR focus tree to Salazarist Portugal if they win the civil war.
			if = {
				limit = {
					AND = {
						has_dlc = "La Resistance"
						NOT = {
							has_game_rule = {
								rule = POR_focus_tree_selection
								option = R56_TREE
							}
						}
					}
					original_tag = POR
					has_government = neutrality
					has_focus_tree = generic_focus
					FROM = {
						original_tag = POR
						OR = {
							has_government = fascism
							has_government = communism
						}
					}
				}
				load_focus_tree = { tree = portuguese_focus keep_completed = no }
				unlock_national_focus = POR_estado_novo
				unlock_national_focus = POR_support_the_spanish_nationalists
				unlock_national_focus = POR_portuguese_legion
				unlock_national_focus = POR_strengthen_the_regime
			}
			# Give back POR focus tree to Fascist Portugal if they win the civil war.
			if = {
				limit = {
					AND = {
						has_dlc = "La Resistance"
						NOT = {
							has_game_rule = {
								rule = POR_focus_tree_selection
								option = R56_TREE
							}
						}
					}
					original_tag = POR
					has_government = fascism
					has_focus_tree = generic_focus
					FROM = {
						original_tag = POR
						OR = {
							has_government = neutrality
							has_government = democratic
						}
					}
				}
				load_focus_tree = { tree = portuguese_focus keep_completed = no }
				unlock_national_focus = POR_estado_novo
				unlock_national_focus = POR_support_the_spanish_nationalists
				unlock_national_focus = POR_portuguese_legion
				unlock_national_focus = POR_national_syndicalism
			}
		}
	}

	# ROOT is capitulated country, FROM is winner
	on_capitulation = {
		effect = {
			if = { # If SPD lost the SCW but their allies thereafter win it
				limit = {
					original_tag = SPR
					SPR_scw_in_progress = yes
					FROM = { has_country_flag = supports_SPD_flag }
					SPD = { exists = no }
				}
				random_state = {
					limit = {
						controller = { has_country_flag = supports_SPD_flag }
						has_state_flag = SPR_original_core
						if = {
							limit = {
								any_state = {
									controller = { has_full_control_of_state = PREV }
									has_state_flag = SPR_original_core
								}
							}
							controller = { has_full_control_of_state = PREV	}
						}
						if = {
							limit = {
								any_state = {
									controller = { has_full_control_of_state = PREV }
									is_core_of = SPD
								}
							}
							is_core_of = SPD
						}
						else_if = {
							limit = {
								any_state = {
									controller = { NOT = { has_full_control_of_state = PREV } }
									is_core_of = SPD
								}
							}
							is_core_of = SPD
						}
					}
					SPD = {
						transfer_state = PREV
						if = {
							limit = {
								OR = {
									FROM = { tag = SPA }
									SPA = { exists = yes }
								}
							}
							declare_war_on = {
							    target = SPA
							    type = civil_war
							}
							add_civil_war_target = SPA
						}
						if = {
							limit = {
								OR = {
									FROM = { tag = SPB }
									SPB = { exists = yes }
								}
							}
							declare_war_on = {
							    target = SPB
							    type = civil_war
							}
							add_civil_war_target = SPB
						}
						if = {
							limit = {
								OR = {
									FROM = { tag = SPC }
									SPC = { exists = yes }
								}
							}
							declare_war_on = {
							    target = SPC
							    type = civil_war
							}
							add_civil_war_target = SPC
						}
					}
				}
				FROM = {
					diplomatic_relation = {
						country = SPD
						relation = military_access
						active = yes
					}
				}
				SPD = {
					diplomatic_relation = {
						country = FROM
						relation = military_access
						active = yes
					}
				}
				every_country = {
					limit = {
						OR = {
							has_country_flag = supports_SPA_flag
							has_country_flag = supports_SPB_flag
						}
					}
					SPD = {
						declare_war_on = {
							target = PREV 
							type = topple_government
						}
					}
				}
			}
			if = { # If SPA lost the SCW but their allies thereafter win it
				limit = {
					original_tag = SPR
					SPR_scw_in_progress = yes
					FROM = { has_country_flag = supports_SPA_flag }
					SPA = { exists = no }
				}
				random_state = {
					limit = {
						controller = { has_country_flag = supports_SPA_flag }
						has_state_flag = SPR_original_core
						if = {
							limit = {
								any_state = {
									controller = { has_full_control_of_state = PREV }
									has_state_flag = SPR_original_core
								}
							}
							controller = { has_full_control_of_state = PREV }
						}
						if = {
							limit = {
								any_state = {
									controller = { has_full_control_of_state = PREV }
									is_core_of = SPA
								}
							}
							is_core_of = SPA
						}
						else_if = {
							limit = {
								any_state = {
									controller = { NOT = { has_full_control_of_state = PREV } }
									is_core_of = SPA
								}
							}
							is_core_of = SPA
						}
					}
					SPA = {
						transfer_state = PREV
						if = {
							limit = {
								OR = {
									FROM = { tag = SPA }
									SPD = { exists = yes }
								}
							}
							declare_war_on = {
							    target = SPA
							    type = civil_war
							}
							add_civil_war_target = SPD
						}
						if = {
							limit = {
								OR = {
									FROM = { tag = SPB }
									SPB = { exists = yes }
								}
							}
							declare_war_on = {
							    target = SPB
							    type = civil_war
							}
							add_civil_war_target = SPB
						}
						if = {
							limit = {
								OR = {
									FROM = { tag = SPC }
									SPC = { exists = yes }
								}
							}
							declare_war_on = {
							    target = SPC
							    type = civil_war
							}
							add_civil_war_target = SPC
						}
					}
				}
				FROM = {
					diplomatic_relation = {
						country = SPA
						relation = military_access
						active = yes
					}
				}
				SPA = {
					diplomatic_relation = {
						country = FROM
						relation = military_access
						active = yes
					}
				}
				every_country = {
					limit = {
						OR = {
							has_country_flag = supports_SPD_flag
							has_country_flag = supports_SPB_flag
						}
					}
					SPA = {
						declare_war_on = {
							target = PREV 
							type = topple_government
						}
					}
				}
			}
			if = { # If SPB lost the SCW but their allies thereafter win it
				limit = {
					original_tag = SPR
					SPR_scw_in_progress = yes
					FROM = { has_country_flag = supports_SPB_flag }
					SPB = { exists = no }
				}
				random_state = {
					limit = {
						controller = { has_country_flag = supports_SPB_flag }
						has_state_flag = SPR_original_core
						if = {
							limit = {
								any_state = {
									controller = { has_full_control_of_state = PREV }
									has_state_flag = SPR_original_core
								}
							}
							controller = { has_full_control_of_state = PREV }
						}
						if = {
							limit = {
								any_state = {
									controller = { has_full_control_of_state = PREV }
									is_core_of = SPB
								}
							}
							is_core_of = SPB
						}
						else_if = {
							limit = {
								any_state = {
									controller = { NOT = { has_full_control_of_state = PREV } }
									is_core_of = SPB
								}
							}
							is_core_of = SPB
						}
					}
					SPB = {
						transfer_state = PREV
						if = {
							limit = {
								OR = {
									FROM = { tag = SPA }
									SPD = { exists = yes }
								}
							}
							declare_war_on = {
							    target = SPA
							    type = civil_war
							}
							add_civil_war_target = SPD
						}
						if = {
							limit = {
								OR = {
									FROM = { tag = SPD }
									SPB = { exists = yes }
								}
							}
							declare_war_on = {
							    target = SPD
							    type = civil_war
							}
							add_civil_war_target = SPB
						}
						if = {
							limit = {
								OR = {
									FROM = { tag = SPC }
									SPC = { exists = yes }
								}
							}
							declare_war_on = {
							    target = SPC
							    type = civil_war
							}
							add_civil_war_target = SPC
						}
					}
				}
				FROM = {
					diplomatic_relation = {
						country = SPB
						relation = military_access
						active = yes
					}
				}
				SPB = {
					diplomatic_relation = {
						country = FROM
						relation = military_access
						active = yes
					}
				}
				every_country = {
					limit = {
						OR = {
							has_country_flag = supports_SPD_flag
							has_country_flag = supports_SPA_flag
						}
					}
					SPB = {
						declare_war_on = {
							target = PREV 
							type = topple_government
						}
					}
				}
			}
		}
	}


	#ROOT is winner #FROM gets annexed - This fires just before FROM gets annexed, meaning the country and everything it owns still exists. It will also fire on_annex and on_civil_war_end
	on_civil_war_end_before_annexation {
		effect = {
			if = { # Carlists Defeated, civil war not over
				limit = {
					FROM = {
						tag = SPB
						has_completed_focus = SPA_supremacy_of_the_communion
					}
					original_tag = SPR
					SPR_scw_in_progress = yes
					any_other_country = {
						NOT = {
							tag = ROOT
							tag = SPB
						}
						original_tag = SPR
						exists = yes
					}
				}
				country_event = lar_spain.11
			}
			if = { # Fascists Defeated, civil war not over
				limit = {
					FROM = {
						tag = SPA
						has_completed_focus = SPA_the_phalanx_ascendant
					}
					original_tag = SPR
					SPR_scw_in_progress = yes
					any_other_country = {
						NOT = {
							tag = ROOT
							tag = SPA
						}
						original_tag = SPR
						exists = yes
					}
				}
				country_event = lar_spain.12
			}
			if = { # Franco Defeated, civil war not over
				limit = {
					FROM = {
						tag = SPA
						has_completed_focus = SPA_unify_the_nationalist_front
					}
					original_tag = SPR
					SPR_scw_in_progress = yes
					any_other_country = {
						NOT = {
							tag = ROOT
							tag = SPA
						}
						original_tag = SPR
						exists = yes
					}
				}
				country_event = lar_spain.13
			}
			if = { # Anarchists Defeated, civil war not over
				limit = {
					FROM = {
						tag = SPC
						has_completed_focus = SPR_regional_defense_council_of_aragon
					}
					original_tag = SPR
					SPR_scw_in_progress = yes
					any_other_country = {
						NOT = {
							tag = ROOT
							tag = SPC
						}
						original_tag = SPR
						exists = yes
					}
				}
				country_event = lar_spain.14
			}
			if = { # Independent Communist Defeated, civil war not over
				limit = {
					FROM = {
						tag = SPC
						has_completed_focus = SPR_the_anti_fascist_workers_revolution
					}
					original_tag = SPR
					SPR_scw_in_progress = yes
					any_other_country = {
						NOT = {
							tag = ROOT
							tag = SPC
						}
						original_tag = SPR
						exists = yes
					}
				}
				country_event = lar_spain.15
			}
			if = { # Democrats Defeated, civil war not over
				limit = {
					FROM = {
						tag = SPD
						has_completed_focus = SPR_maintain_the_second_republic
					}
					original_tag = SPR
					SPR_scw_in_progress = yes
					any_other_country = {
						NOT = {
							tag = ROOT
							tag = SPD
						}
						original_tag = SPR
						exists = yes
					}
				}
				country_event = lar_spain.16
			}
			if = { # Stalinist Communists Defeated, civil war not over
				limit = {
					FROM = {
						tag = SPD
						has_completed_focus = SPR_the_anti_fascist_workers_revolution
					}
					original_tag = SPR
					SPR_scw_in_progress = yes
					any_other_country = {
						NOT = {
							tag = ROOT
							tag = SPD
						}
						original_tag = SPR
						exists = yes
					}
				}
				country_event = lar_spain.17
			}
		}
	}

	#ROOT is new controller #FROM is old controller #FROM.FROM is state ID
	on_state_control_changed = {
		effect = {
			if = {
				limit = {
					tag = FRA
					has_completed_focus = FRA_french_forces_of_the_interior
					FROM.FROM = {
						is_core_of = ROOT
						not = { has_state_flag = FRA_core_state_liberated }
					}
				}
				FROM.FROM = {
					set_state_flag = FRA_core_state_liberated
					create_unit = {
						division = "name = \"1re Demi-Brigade de Chasseurs\" division_template = \"FFI Demi-Brigade\" start_experience_factor = 0"  
						owner = ROOT
					}
					create_unit = {
						division = "name = \"2me Demi-Brigade de Chasseurs\" division_template = \"FFI Demi-Brigade\" start_experience_factor = 0"  
						owner = ROOT
					}
					create_unit = {
						division = "name = \"3me Demi-Brigade de Chasseurs\" division_template = \"FFI Demi-Brigade\" start_experience_factor = 0"  
						owner = ROOT
					}
				}
			}
			if = {
				limit = {
					FROM.FROM = {
						OR = {
							state = 165
							state = 171
							state = 792
						}
					}
					OR = {
						has_completed_focus = SPA_strengthen_the_supreme_reality_of_spain
						has_completed_focus = SPA_adopt_the_26_points
						has_completed_focus = SPA_confirm_the_fueros
						has_completed_focus = SPR_all_must_bear_the_torch
						has_completed_focus = SPR_all_must_do_their_part
						has_completed_focus = SPR_red_bulwark_in_the_west
					}
				}
				FROM.FROM = {
					remove_dynamic_modifier = { modifier = autonomous_state }
					remove_dynamic_modifier = { modifier = semi_autonomous_state }
				}
			}
			if = {
				limit = {
					FROM.FROM = {
						OR = {
							state = 165
							state = 171
							state = 792
						}
					}
					OR = {
						AND = {
							has_completed_focus = SPR_united_under_socialism
							NOT = { has_completed_focus = SPR_all_must_do_their_part }
						}
						AND = {
							has_completed_focus = SPR_solidify_government_control
							NOT = { has_completed_focus = SPR_red_bulwark_in_the_west }
						}
					}
				}
				FROM.FROM = {
					remove_dynamic_modifier = { modifier = autonomous_state }
					add_dynamic_modifier = { modifier = semi_autonomous_state }
				}
			}
		}
	}

	#THIS is country that has just gotten into a war
	on_war = {
		effect = {
			if = {
				limit = {
					tag = VIC
				}
				set_rule = { 
					can_join_factions = yes
					can_create_factions = yes
					can_not_declare_war = no #I hate this thing so much
				}
			}
			if = {
				limit = {
					has_country_flag = SPA_iberian_pact
				}
				save_event_target_as = iberian_pact_war_target
				random_other_country = {
					limit = {
						has_country_flag = SPA_iberian_pact
						NOT = {
							has_war_together_with = ROOT
						}
					}
					country_event = lar_spain.29
				}
			}
		}
	}

	on_weekly = {
		effect = {
			if = {
				limit = { 
					has_intelligence_agency = yes
					is_ai = yes
				}
				update_operation_ai = yes
			}
		}
	}

	on_annex = {
		effect = {
			# Portuguese Anarchism
			if = {
				limit = {
					original_tag = POR
					has_government = neutrality
					has_country_flag = SPR_portuguese_anarchism_flag
					FROM = {
						original_tag = POR
					}
					SPC = {
						exists = yes
						has_completed_focus = SPR_portuguese_anarchism
					}
				}
				SPC = { country_event = lar_spain.50 }
			}
			if = {
				limit = {
					original_tag = POR
					has_global_flag = SPR_portuguese_anarchism_flag
					FROM = {
						original_tag = POR
						has_country_flag = SPR_portuguese_anarchism_flag
					}
				}
				clr_global_flag = SPR_portuguese_anarchism_flag
				set_rule = { can_join_factions = yes }
			}
		}
	}
	
	# scope is operative
	# from scope is the country 
	#on_operative_recruited = {
	#	effect = {
	#	
	#	}
	#}
	
	# scope is operative
	# from scope is the country 
	on_operative_created = {
		effect = {
			if = {
				limit = {
					FROM = {
						has_done_agency_upgrade = upgrade_linguistic_training
					}
					has_trait = operative_linguist
				}
				random_country = {
					limit = {
						NOT = {
							OR = {
								is_puppet_of = FROM
								is_in_faction_with = FROM
								tag = FROM
							}
						}								
						OR = {
							is_major = yes
							is_neighbor_of = FROM
							has_war_with = FROM
						}
					}
					ROOT = {
						add_nationality = PREV
					}									
				}
			}
			if = {
			 #add target nationality
				limit = {
					has_nationality = BEL
				}
				random_list = {
					54 = {
						add_nationality = VLA
					}
					44 = { 
						add_nationality = WLL
					}
					1 = { 
						add_nationality = LUX
					}
					1 = { 
						add_nationality = HOL
					}																								
				}
			}				
			if = {
				#add target nationality
				limit = {
					has_nationality = VLA
				}
				random_list = {
					97 = {
						add_nationality = BEL
					}
					2 = { 
					   add_nationality = FRA
					}
					1 = { 
						add_nationality = HOL
					}																								
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = WLL
				}
				random_list = {
					98 = {
						add_nationality = BEL
					}
					2 = { 
						add_nationality = FRA
					}
					1 = { 
						add_nationality = LUX
					}																								
				}
			}			
			if = {
				#add target nationality
				limit = {
					has_nationality = ARM
				}
				random_list = {
					97 = {
						
					}
					2 = { 
						add_nationality = GEO
					}
					1 = { 
						add_nationality = AZR
					}
					1 = { 
						add_nationality = GRE
					}																													
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = GEO
				}
				random_list = {
					97 = {
						
					}
					2 = { 
						add_nationality = ARM
					}
					1 = { 
						add_nationality = SOV
					}																								
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = PER
				}
				random_list = {
					96 = {
						
					}
					2 = { 
						add_nationality = AFG
					}
					1 = { 
						add_nationality = ARM
					}
					1 = { 
						add_nationality = IRQ
					}																													
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = PAL
				}
				random_list = {
					95 = {
						
					}
					3 = { 
						add_nationality = SYR
					}
					2 = { 
						add_nationality = JOR
					}																								
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = LEB
				}
				random_list = {
					94 = {
						
					}
					4 = { 
						add_nationality = SYR
					}
					2 = { 
						add_nationality = PAL
					}																								
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = SYR
				}
				random_list = {
					94 = {
						
					}
					3 = { 
						add_nationality = LEB
					}
					2 = { 
						add_nationality = PAL
					}
					1 = { 
						add_nationality = IRQ
					}																													
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = IRQ
				}
				random_list = {
					95 = {
						
					}
					2 = { 
						add_nationality = KUR
					}
					1 = { 
						add_nationality = PER
					}
					1 = { 
						add_nationality = KWT
					}					
					2 = { 
						add_nationality = SYR
					}																													
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = KUR
				}
				random_list = {
					90 = {
						
					}
					3 = { 
						add_nationality = IRQ
					}
					1 = { 
						add_nationality = PER
					}
					5 = { 
						add_nationality = TUR
					}					
					1 = { 
						add_nationality = SYR
					}																													
				}
			}			
			if = {
				#add target nationality
				limit = {
					has_nationality = ADU
				}
				random_list = {
					98 = {
						
					}
					1 = { 
						add_nationality = MOR
					}
					1 = { 
						add_nationality = ALG
					}																													
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = SOV
				}
				random_list = {
					98 = {
						
					}
					1 = { 
						add_nationality = UKR
					}
					1 = { 
						add_nationality = BLR
					}																													
				}
			}																														
			if = {
				 #add target nationality
				limit = {
					has_nationality = YUG
				}
				random_list = {
					45 = {
						add_nationality = SER
						random_list = {
							85 = { 
							
							}
							15 = { 
								add_nationality = MNT
							}						
						}
					}
					10 = { 
						add_nationality = SLV
					}
					2 = { 
						add_nationality = MAC
					}
					3 = { 
						add_nationality = MNT
					}					
					25 = { 
						add_nationality = CRO
						random_list = {
							90 = { 
							
							}
							10 = { 
								add_nationality = BOS
								add_nationality = HRZ
							}						
						}						
					}	
					15 = { 
						add_nationality = BOS
						add_nationality = HRZ
						random_list = {
							70 = { 
							
							}
							15 = { 
								add_nationality = SER
							}
							15 = { 
								add_nationality = CRO
							}													
						}						
					}																															
				}								
			}
			if = {
				#add target nationality
				limit = {
					OR = {
						has_nationality = SLV
						has_nationality = CRO
						has_nationality = SER
						has_nationality = MNT
						has_nationality = BOS
						has_nationality = HRZ
					}
					NOT = {
						has_nationality = YUG
					}  
			   	}
			   	add_nationality = YUG							
			}			
			if = {
				#add target nationality
			    limit = {
				   has_nationality = FRA
			    }
			    random_list = {
				    25 = {
				 	   add_nationality = OCC
				    }
				    5 = { 
				 	   add_nationality = BRI
					}
				    3 = { 
						add_nationality = COR
				    }					
				    67 = { 
				 	 
				    }																														
				}									
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = OCC
			   	}
				random_list = {
				    20 = {
				 	   add_nationality = FRA
				    }
					1 = { 
				 	   add_nationality = ITA
					}
					1 = { 
						add_nationality = SWI
					}
					1 = { 
						add_nationality = NAV
					}
					1 = { 
						add_nationality = SPR
					}															
				    76 = { 
				 	 
				    }																														
				}						
			}			
			if = {
			#add target nationality
				limit = {
					has_nationality = ENG
				}
		   		random_list = {
					20 = {
						add_nationality = SCO
					}
					8 = { 
						add_nationality = NIR
					}
					8 = { 
						add_nationality = WLS
					}
					2 = { 
						add_nationality = AST
					}
					2 = { 
						add_nationality = SAF
					}
					2 = { 
						add_nationality = CAN
					}					
					1 = { 
						add_nationality = NZL
					}																			
					57 = { 
					
					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = CAN
				}
				random_list = {
					97 = {
						
					}
					1 = { 
						add_nationality = USA
					}
					1 = { 
						add_nationality = ENG
					}
					1 = { 
						add_nationality = QBC
					}
				}																														
			}			
			if = {
				#add target nationality
				limit = {
					has_nationality = PAK
				}
				random_list = {
					7 = { 
						add_nationality = RAJ
					}					
					3 = { 
						add_nationality = BAN
					}
					1 = { 
						add_nationality = AFG
					}																									
					89 = { 
					
					}
				}																														
			}			
			if = {
				#add target nationality
				limit = {
					OR = {
						has_nationality = PRE
						has_nationality = BAY
						has_nationality = WUR
						has_nationality = BAD
						has_nationality = WGR
						has_nationality = DDR
						has_nationality = SAX
						has_nationality = MEK
						has_nationality = SHL
						has_nationality = DNZ
					}
					
				}
				add_nationality = GER																													
			}
			if = {
				#add target nationality
				limit = {
					OR = {
						has_nationality = SHX
						has_nationality = XSM
						has_nationality = SIK
						has_nationality = GXC
						has_nationality = YUN
					}	
				}
				add_nationality = CHI																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = MON
				}
				random_list = {
					5 = {
						add_nationality = MEN
					}
					94 = { 
						
					}
					1 = { 
						add_nationality = TAN
					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = MEN
				}
				random_list = {
					15 = {
						add_nationality = MON
					}
					85 = { 
						
					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = TAN
				}
				random_list = {
					5 = {
						add_nationality = MON
					}
					95 = { 
						
					}
				}																									
			}			
			if = {
				#add target nationality
				limit = {
					has_nationality = KOR
				}
				random_list = {
					2 = {
						add_nationality = MAN
					}
					88 = { 
						
					}
				}																												
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = BUL
				}
				random_list = {
					3 = {
						add_nationality = MAC
						add_nationality = YUG
					}
					1 = {
						add_nationality = GRE
					}					
					96 = { 
						
					}
				}																													
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = CZE
				}
				random_list = {
					1 = {
						add_nationality = RUT
					}
					25 = {
						add_nationality = SLO
					}					
					74 = { 
						
					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = SLO
				}
				random_list = {
					1 = {
						add_nationality = RUT
					}
					15 = {
						add_nationality = CZE
					}					
					84 = { 
						
					}
				}																														
			}			
			if = {
				#add target nationality
				limit = {
					has_nationality = ITA
				}
				random_list = {
					50 = {
						add_nationality = VNZ
					}
					150 = {
						add_nationality = NAP
					}					
					20 = { 
						add_nationality = SAD
					}
					30 = { 
						add_nationality = SIC
					}
					1 = { 
						add_nationality = PRU
					}
					1 = { 
						add_nationality = ARG
					}
					1 = { 
						add_nationality = USA
					}
					1 = { 
						add_nationality = BRA
					}
					1 = { 
						add_nationality = CRO
						add_nationality = YUG
					}
					1 = { 
						add_nationality = COR
					}																														
					744 = { 

					}										
				}																													
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = HOL
					FROM = {
						original_tag = HOL
						6 = {
							is_owned_by = FROM
						}
					}
				}
				random_list = {
					10 = {
						add_nationality = VLA
					}
					90 = {
					
					}															
				}																													
			}						
			if = {
				#add target nationality
				limit = {
					has_nationality = ISR
				}
				random_list = {
					1 = {
						add_nationality = USA
					}
					3 = {
						add_nationality = ENG
					}
					6 = {
						add_nationality = GER
					}
					8 = {
						add_nationality = POL
					}
					4 = {
						add_nationality = BLR
					}
					3 = {
						add_nationality = LIT
					}
					1 = {
						add_nationality = ITA
					}
					2 = {
						add_nationality = FRA
					}
					1 = {
						add_nationality = BEL
					}
					4 = {
						add_nationality = UKR
					}
					3 = {
						add_nationality = SOV
					}
					1 = {
						add_nationality = BUL
					}
					1 = {
						add_nationality = ROM
					}
					1 = {
						add_nationality = GRE
					}
					1 = {
						add_nationality = SWE
					}
					1 = {
						add_nationality = SWI
					}										
					1 = {
						add_nationality = MOR
					}
					1 = {
						add_nationality = EGY
					}
					1 = {
						add_nationality = IRQ
					}
					1 = {
						add_nationality = ALG
					}																																																																																					
					55 = { 
						
					}
				}																													
			}
			if = {
				#add target nationality
				limit = {
					FROM = {
						original_tag = GER
					}					
					has_nationality = GER
				}
				random_list = {
					80 = {
						
					}
					1 = { 
						add_nationality = SLV
					}
					1 = { 
						add_nationality = HUN
					}
					1 = { 
						add_nationality = ROM
					}
					1 = { 
						add_nationality = LIT
					}
					1 = { 
						add_nationality = LAT
					}
					1 = { 
						add_nationality = EST
					}
					1 = { 
						add_nationality = POL
					}
					2 = { 
						add_nationality = CZE
					}																													
					12 = { 
						add_nationality = AUS
					}					
				}																													
			}
			if = {
				#add target nationality
				limit = {
					FROM = {
						original_tag = AUS
					}					
					has_nationality = AUS
				}
				random_list = {
					92 = {
						
					}
					1 = { 
						add_nationality = SLV
					}
					2 = { 
						add_nationality = HUN
					}
					1 = { 
						add_nationality = ROM
					}
					1 = { 
						add_nationality = ITA
					}
					1 = { 
						add_nationality = CZE
					}
					2 = { 
						add_nationality = GER
					}					
				}																													
			}																										
			if = {
				#add target nationality
				limit = {
					OR = {
						has_nationality = VNZ
						has_nationality = SAD
						has_nationality = NAP
						has_nationality = SIC
					}	
				}
				add_nationality = ITA																													
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = FRI
				}
				random_list = {
					66 = {
						add_nationality = VIN
					}
					24 = { 
						add_nationality = CAM
					}
					10 = { 
						add_nationality = LAO
					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = RUT
				}
				random_list = {
					70 = {
						add_nationality = UKR
					}
					10 = { 
						add_nationality = SLO
					}
					10 = { 
						add_nationality = HUN
					}
					10 = { 

					}					
				}																											
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = HUN
				}
				random_list = {
					7 = {
						add_nationality = SZK
						add_nationality = ROM
					}
					4 = {
						add_nationality = RUT
					}
					1 = { 
						add_nationality = AUS
					}
					1 = { 
						add_nationality = SER
						add_nationality = YUG
					}																				
					87 = { 
					
					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = ROM
					NOT = {
						has_nationality = HUN
					}
				}
				random_list = {
					5 = {
						add_nationality = MOL
					}
					95 = { 
						
					}
				}																													
			}			
			if = {
				#add target nationality
				limit = {
					has_nationality = TIB
				}
				random_list = {
					95 = {
					
					}
					5 = {
						add_nationality = CHI
					}										
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = RAJ
					RAJ = {
						is_puppet_of = ENG
						has_cosmetic_tag = RAJ_UK
					}	
				}

				random_list = {
					20 = {
						add_nationality = SCO
						add_nationality = ENG
					}
					8 = { 
						add_nationality = NIR
						add_nationality = ENG
					}
					8 = { 
						add_nationality = WLS
						add_nationality = ENG
					}				
					64 = { 
						add_nationality = ENG
					}
				}																															
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = POR
					POR = {
						has_cosmetic_tag = KPB_kingdom_portugal_and_brazil	
					}
				}

				random_list = {
					50 = {
						add_nationality = BRA
					}			
					50 = { 

					}
				}																													
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = BRA
				}
				random_list = {
					1 = {
						add_nationality = URG
					}
					1 = {
						add_nationality = POR
					}								
					98 = { 

					}
				}																													
			}						
			if = {
				#add target nationality
				limit = {
					has_nationality = ALB
				}
				random_list = {
					3 = {
						add_nationality = KOS
					}			
					97 = { 

					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = GRE
				}
				random_list = {
					3 = {
						add_nationality = CYP
					}
					1 = { 
						add_nationality = ALB
					}								
					96 = { 

					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = TUR
				}
				random_list = {
					1 = {
						add_nationality = GRE
					}
					1 = {
						add_nationality = LBA
					}
					1 = {
						add_nationality = IRQ
					}
					1 = {
						add_nationality = CYP
					}
					1 = {
						add_nationality = EGY
					}
					1 = {
						add_nationality = BUL
					}																												
					94 = { 

					}
				}																									
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = EGY
				}
				random_list = {
					1 = {
						add_nationality = PAL
					}
					1 = {
						add_nationality = LBA
					}
					2 = {
						add_nationality = SUD
					}																												
					96 = { 

					}
				}																														
			}						
			if = {
				#add target nationality
				limit = {
					has_nationality = IRE
					FROM = {
						original_tag = IRE						
					}					
				}
				random_list = {
					15 = {
						add_nationality = NIR
						random_list = {
							40 = {
								add_nationality = ENG
							}
							60 = {

							}
						}
					}
					1 = {
						add_nationality = USA
					}								
					84 = { 

					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = IRE
					FROM = {
						NOT = {
							original_tag = IRE
						}
											
					}					
				}
				random_list = {
					15 = {
						add_nationality = NIR
					}								
					85 = { 

					}
				}																														
			}			
			if = {
				#add target nationality
				limit = {
					has_nationality = LIT
				}
				random_list = {
					15 = {
						add_nationality = POL
					}			
					85 = { 

					}
				}																															
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = SWE
				}
				random_list = {
					1 = {
						add_nationality = SAM
					}
					1 = {
						add_nationality = AHV
					}								
					98 = { 

					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = DEN
				}
				random_list = {
					1 = {
						add_nationality = ICE
					}
					1 = {
						add_nationality = GRL
					}
					1 = {
						add_nationality = GER
					}													
					97 = { 

					}
				}																													
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = FIN
				}
				random_list = {
					3 = {
						add_nationality = SAM
					}
					5 = {
						add_nationality = SWE
					}													
					92 = { 

					}
				}																													
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = NOR
				}
				random_list = {
					3 = {
						add_nationality = SAM
					}								
					97 = { 

					}
				}																												
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = JAP
					FROM = {
						original_tag = JAP						
					}					
				}
				random_list = {
					10 = {
						add_nationality = KOR
					}
					10 = {
						add_nationality = MAN
					}
					5 = {
						add_nationality = USA
					}					
					5 = {
						add_nationality = PRU
					}
					5 = {
						add_nationality = BRA
					}
					1 = {
						add_nationality = PAN
					}																												
					964 = { 

					}
				}																													
			}	
			if = {
				#add target nationality
				limit = {
					has_nationality = JAP
					FROM = {
						NOT = {
							original_tag = JAP
						}
					}
				}
				random_list = {
					1 = {
						add_nationality = KOR
					}
					1 = {
						add_nationality = MAN
					}																											
					98 = { 

					}
				}																														
			}																				
			if = {
				#add target nationality
				limit = {
					OR = {
						has_nationality = SPR
						has_nationality = SPA
					}
					
				}
				random_list = {
					15 = {
						add_nationality = CAT
					}					
					5 = {
						add_nationality = NAV
					}
					3 = {
						add_nationality = GLC
					}								
					77 = { 

					}
				}																													
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = NAV
				}
				random_list = {
					20 = {
						add_nationality = OCC
					}
					40 = {
						add_nationality = SPR
					}													
					40 = { 

					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = ARG
				}
				random_list = {
					5 = {
						add_nationality = SPR
					}
					5 = { 
						add_nationality = ITA
					}
					3 = { 
						add_nationality = URG
					}					   
					2 = { 
						add_nationality = PAR
					}
					1 = { 
						add_nationality = BOL
					}
					84 = { 
					
					}																													
				}
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = MEN
				}
				random_list = {
					50 = {
						add_nationality = MON
					}
					10 = {
						add_nationality = MON
						add_nationality = BUR
					}
					20 = { 
						add_nationality = CHI
					}										
					20 = { 
						
					}
				}																														
			}
			if = {
				#add target nationality
				limit = {
					has_nationality = MON
				}
				random_list = {
					50 = {
						add_nationality = MEN
					}
					10 = {
						add_nationality = MEN
						add_nationality = BUR
					}
					20 = { 
						add_nationality = BUR
					}										
					20 = { 
						
					}
				}																														
			}																																																									   						
		}
	}
}
